name: "JAR to Executable"
description: "Runs a specified JAR and saves the resulting standalone executable to Output"
inputs:
  id:
    description: "ID of the program (minus extension)"
    required: true
  name:
    description: "Name of the program. Default to `id` if unspecified."
    required: false
  icon:
    description: "Path to the icon"
    required: true
  desktop-file:
    description: "Path to the desktop file (Linux)"
    required: false
  input:
    description: "Path to the JAR file (Linux) or to jpackage generated app-image folder (Windows)"
    required: true
  output:
    description: "Path to save the output"
    required: true

runs:
  using: "composite"
  steps:
    - name: Build AppImage (Linux)
      if: runner.os == 'Linux'
      shell: bash
      env:
        PROGRAM: "${{ inputs.id }}"
        PROGRAM_NAME: "${{ inputs.name }}"
        PROGRAM_ICON: "${{ inputs.icon }}"
        PROGRAM_DESKTOP_FILE: "${{ inputs.desktop-file }}"
        INPUT: "${{ inputs.input }}"
        OUTPUT: "${{ inputs.output }}"
      run: |
        chmod +x ${{ github.action_path }}/package.sh
        ${{ github.action_path }}/package.sh
        
    - name: Build Portable EXE (Win)
      if: runner.os == 'Windows'
      shell: pwsh
      env:
        PROGRAM: "${{ inputs.id }}"
        PROGRAM_NAME: "${{ inputs.name }}"
        INPUT: "${{ inputs.input }}"
        OUTPUT: "${{ inputs.output }}"
      run: |
        $archive = "$env:PROGRAM.7z"
        $lzma_download_url = "https://github.com/ip7z/7zip/releases/latest/download/lzma2501.7z"

        # Fetch 7-Zip SFX executable header
        Invoke-WebRequest -Uri $lzma_download_url -OutFile lzma.7z
        7z e lzma.7z 7zS2con.sfx -r -y
        Remove-Item lzma.7z -Force

        # Compress the folder into archive
        7z a $archive $env:INPUT

        # Combine SFX header + archive into final portable executable
        cmd.exe /c copy /b 7zS2con.sfx + $archive $env:OUTPUT

        Remove-Item $archive, 7zS2con.sfx -Force
